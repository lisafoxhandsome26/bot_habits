<h1>Бот трекинга привычек</h1>

<h2>Структура проекта:</h2>
<ul>
    <li>config - Конфигурационные настройки бота</li>
    <li>dotinputs - Телеграмм бот</li>
    <li>fast_app - backend и база данных бота</li>
    <li>migrations - Миграции базы данных</li>
    <li>requirements - Зависимости бота и backend</li>
</ul>

<h2>Описание:</h2>
<p>Телеграмм бот который помогает изменить вашу жизнь к лучшему</p>

<h3>Config</h3>
<p>Config предназначен для установки основных настроек и подтягивания переменных окружения из файла .env
Основной класс "Settings" является наследником класса BaseSettings из pydentic_settings.
Экземпляр "env" предназначен для получения доступа к переменным окружения по всему проекту.
</p>
<p>Переменные окружения используемые в проекте</p>
<ul>
    <li>
        TOKEN - Токен Телеграмм бота получаемый ботом @botfather из телеграмм
    </li>
    <li>
        PROJECT_NAME - Имя проекта, задается пользователем
    </li>
    <li>
        CORS_ALLOWED_ORIGINS - Разрешенный хост по которому предоставляется доступ совершать запросы к backend
    </li>
    <li>
        MAIN_HOST - Основной хост по которому выполняются запросы к backend
    </li>
    <li>
        DB_USER - Имя пользователя для подключения к БД
    </li>
    <li>
        DB_PASS - Пароль пользователя для подключения к БД
    </li>
    <li>
        DB_NAME - Название БД
    </li>
    <li>
        DB_PORT - Порт для подключения к БД
    </li>
    <li>
        DB_HOST - Хост для подключения к БД
    </li>
    <li>
        database_url_async - асинхронный url адрес для подключения к БД 
    </li>
    <li>
        database_url_sync - синхронный url адрес для подключения к БД
    </li>
</ul>

<h3>Migrations</h3>
<p>Миграции БД выполненняются с помощью alembic. В проекте уже подготовлена первая миграция
которая применится командой "alembic upgrade head" при старте телеграмм бота.
</p>

<h3>Requirements</h3>
<p>Зависимости проекта разделены на две группы</p>
<ul>
    <li>
        <p>Зависимости для бота:</p>
        <ul>
            <li>
                requests - библиотека для выполнения запросов к backend
            </li>
            <li>
                pytelegrambotapi - Основная библиотека на котором написан бот
            </li>
            <li>
                pydantic-settings - Библиотека для подгрузки переменных окружения
            </li>
            <li>
                apscheduler - Библиотека для создания очередей задач на отправку уведомлений о привычках
            </li>
            <li>
                sqlalchemy - ORM для подключения к БД
            </li>
            <li>
                psycopg2-binary - Драйвер для синхронного подключения к БД
            </li>
        </ul>
    </li>
    <li>
        <p>Зависимости для backend:</p>
        <ul>
            <li>
                fastapi - основной фреймворк backend
            </li>
            <li>
                uvicorn - ASGI сервер для запуска синхронного backend
            </li>
            <li>
                pydantic - библиотека для проверки и сериализации данных
            </li>
            <li>
                pydantic-core - Ядро pydentic
            </li>
            <li>
                httpx - полнофункциональный HTTP-клиент
            </li>
            <li>
                pydantic-settings - Библиотека для подгрузки переменных окружения
            </li>
            <li>
                alembic - Для создания миграций в БД
            </li>
            <li>
                sqlalchemy - ORM для подключения к БД
            </li>
            <li>
                asyncpg - Драйвер для асинхронного подключения к БД
            </li>
        </ul>
    </li>
</ul>
<p>Все завсисимости контролируются и устанавливаются через Poetry</p>

<h3>fast_app</h3>
<p>fast_app - Это backend отвечающий за получение/отправку запросов 
телеграмм бота, а также хранение данных о пользователях, 
и подготовка данных для отправки обртно боту
</p>
<p>fast_app состоит из:</p>
<ul>
    <li>
        <p>backend написан на fastAPI. Основные url адреса выполняют функцию отправки данных
        url адреса с http методами GET.
        удаления данных DELETE, изменения PATCH и добавления данных POST
        </p>
    </li>
    <li>
        <p>database - Взаимодействие с БД. В database описаны основные Модели данных User, 
        Habit, Tracking. Также описаны основные асинхронные функции для выполнения запросов 
        к БД.
        Взаимодействие с БД выполнено на основе SQLAlchemy с асинхронным подключением к БД
        СУБД используемая в проекте - postgres.
        </p>
    </li>
    <li>
        <p>schemases - Модели pydentic которые используются для сериализации и подготовки
        необходимой структуры данных перед отправкой боту. Модели pydentic это зеркальное
        отражение моделей БД.
        </p>
    </li>
</ul>

<h3>dotinputs</h3>
<p>dotinputs - Телеграмм бот</p>
<p>dotinputs- Это основной блок на котором держится весь проект.
dotinputs отвечает за состояния пользователя с ботом, а также подготавливает
данные для запросов пользователя и отправляет их обратно
</p>
<p>dotinputs написан на основе pytelegrambotapi.
Отправка автоматических уведомлений осуществляется через apscheduler
</p>
<p>
Все обработчики сообщений разделены на три блока:
</p>
<ul>
    <li>
        main_handlers - Основной обработчик в котором сосредоточены основные команды
    </li>
    <li>
        handle_registration - Обработчик-опросник для знакомства бота с пользователем
        во время регистрации.
    </li>
    <li>
        handle_habits - Обработчики сообщений по привычкам пользователя
    </li>
</ul>
<p>
Дополнительные функции-помошники вынесены в модуль utils.py. В этом модуле
описаны основные функции для вылидации вводимых данных пользователя, подготовки
интерактивного смс, получения профиля и проверки пользователя на предмет авторизации
</p>
<p>Отдельно вынесены шаблоны кнопок телеграмм бота в модуль buttons.py</p>
<p>states.py - Модуль в котором описаны состояния пользователя во время 
регистрации
</p>
<p>scheduler - отвечает за организацию и контроль отправки автоматических уведомелний
с заданным сроком. Основная библиотека - apscheduler
</p>
<p>scheduler состоит из core.py - подключение к БД и 
BackgroundScheduler который запускает фоновые отдельные потоки.
handle_schedule.py - модуль для контроля над фоновыми потоками
</p>
<p>
В handle_schedule.py Реаизована логика по добавлению удалению, приостановке
и продолжению потоков. В модуле имеется обработчик сообщений по выполнению
запросов на редактирование статуса привычки.
</p>

<h3>Запуск телеграмм бота</h3>
<p>Весь запуск и контроль работы телеграмм бота выполняется через Docker</p>
<p>Запуск бота выполняется через клонирование из удаленного репозитория github 
c последующей подготовкой переменных окружения через файл .env. 
После подготовки телебот запускается через docker командой docker compose up.
</p>
<p>
Структура проекта реализована таким образом что основные блоки
проекта (bot, backend, database) независимы друг от друга и могут запускаться
на различных серверах или отдельно друг от друга. Но в проекте реализован запуск
всех блоков проекта одним разом через docker-compose.yml
</p>

<h2>Взаимодействие бота с пользователем</h2>
<h3>Первое знакомство бота c пользователем</h3>
<p>При вводе команды /start Бот предложит пользователю познакомится 
и зарегестрироваться, задав пользователю ряд вопросов
</p>
<br>
<img alt="img.jpg" height="700" src="images/registration.PNG" width="450"/>

<p>После регистрации бот отправит полученные данные на backend и после этого 
пользователь получит следующие кнопки</p>

<img alt="img.jpg" height="" src="images/main_buttons.PNG" width="450"/>

<p>Нажимаем на кнопку "Узнать инфо о себе"</p>

<img alt="img.jpg" height="" src="images/info_user.PNG" width="450"/>

<p>
Бот выведит информацию о пользователе 
Нажимаем на кнопку "Вкладка с привычками"
</p>


<img alt="img.jpg" height="" src="images/page_habits.PNG" width="450"/>

<p>Бот перейдет на вкладку с привычками и предоставит кнопки:
Нажимаем на кнопку "Перейти на статус привычек"</p>

<img alt="img.jpg" height="" src="images/list_habits.PNG" width="450"/>

<p>Наш спиок привычек пока пуст. Хорошо. Давайте добавим привычку
Нажав на кнопку "Добавить привычку"</p>

<img alt="img.jpg" height="" src="images/add_habits.PNG" width="450"/>

<p>Бот задаст несколько вопросов, после которых будет отправлен запрос к backend
на добавление привычки</p>

<p>Нажмем на кнопку "Перейти на статус привычек"</p>

<img alt="img.jpg" height="" src="images/habit.PNG" width="450"/>

<p>Видим добавленную привычку. Давайте изменим ее
Нажав при этом на кнопку "Изменить привычку"</p>

<img alt="img.jpg" height="" src="images/list_edit_habits.PNG" width="450"/>

<p>Бот предложит список ваших привычек для изменеия. Выберим номер 1</p>

<img alt="img.jpg" height="" src="images/choice_habit.PNG" width="450"/>

<p>Бот предложит изменить каждый параметр по отдельности или все параметры
сразу. Давайте изменим параметр "Название" нажав на соответствующую кнопку</p>

<img alt="img.jpg" height="" src="images/edit_name.PNG" width="450"/>

<p>Изменим название на "Выгуливать собаку", после этого бот предложит согласие на изменение
привычки, соглашаемся и привычка изменена. Давайте в этом убедимся нажав на кнопку
"Перейти на статус привычек"</p>

<img alt="img.jpg" height="" src="images/new_name.PNG" width="450"/>

<p>Видим что название привычки изменено. Давайте удалим привычку, нажав на кнопку
"Удалить"</p>

<img alt="img.jpg" height="" src="images/del_habit.PNG" width="450"/>

<p>Выбираем номер привычки который хотим удалить и подтверждаем удаление.
Бот отправляет сообщение об успешном выполнении операции.
Что бы в этом убедится перейдем на статус привычек</p>

<img alt="img.jpg" height="" src="images/check.PNG" width="450"/>

<p>И видим что наш список привычек пуст. Вернемся назад нажав на кнопку 
"Вернуться назад"</p>

<img alt="img.jpg" height="" src="images/step_last.PNG" width="450"/>

<p>И увидим наш профиль, давайте выйдим из своего профиля 
нажав на кнопку "Выйти из своего профиля"</p>

<img alt="img.jpg" height="" src="images/exit_profile.PNG" width="450"/>

<p>После выхода из профиля бот не будет вас беспокоить автоматическими напоминаниями. 
имейте это в виду. Чтобы бот постоянно вам напоминал. Вы должны быть
авторизованы. Авторизуемся введя команду /start</p>

<img alt="img.jpg" height="" src="images/authorization.PNG" width="450"/>

<p>Нажмем на кнопку авторизоваться и перейдем в свой профиль</p>

<img alt="img.jpg" height="" src="images/step_last.PNG" width="450"/>